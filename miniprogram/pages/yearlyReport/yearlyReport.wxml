<view class="yearly-report-container">
  <!-- åŠ è½½ä¸­ -->
  <view wx:if="{{loading}}" class="loading-container">
    <van-loading type="spinner" size="24px" vertical>ç”ŸæˆæŠ¥å‘Šä¸­...</van-loading>
  </view>

  <!-- æŠ¥å‘Šå†…å®¹ -->
  <view wx:else class="report-content">
    <!-- ä¸ªæ€§åŒ–å¼€ç¯‡é¡µ -->
    <view class="report-header">
      <view class="report-title">@{{stats.userInfo.nickName}} çš„{{year}}ä½“é‡èœ•å˜æŠ¥å‘Š</view>
      <view class="report-subtitle" wx:if="{{stats.weightChange !== null && stats.weightChange < 0}}">
        è¿™ä¸€å¹´ï¼Œä½ ç”¨{{stats.totalDays}}å¤©åšæŒï¼Œæ‚„æ‚„ç˜¦äº†{{absWeightChange}}æ–¤ï½
      </view>
      <view class="report-subtitle" wx:elif="{{stats.totalDays > 0}}">
        è¿™ä¸€å¹´ï¼Œä½ åšæŒæ‰“å¡{{stats.totalDays}}å¤©ï¼Œè®°å½•æ¯ä¸€å¤©çš„å˜åŒ–ï½
      </view>
      <view class="report-subtitle" wx:else>
        è®°å½•æ¯ä¸€å¤©çš„å˜åŒ–
      </view>
    </view>
    
    <!-- ä¸ªæ€§æ ‡ç­¾ -->
    <view wx:if="{{stats.personalityTags && stats.personalityTags.length > 0}}" class="tags-container">
      <view class="tag-item" wx:for="{{stats.personalityTags}}" wx:key="index">{{item}}</view>
    </view>

    <!-- æ ¸å¿ƒæ•°æ®å¡ç‰‡ -->
    <view class="stats-card main-card">
      <view class="main-card-bg"></view>
      <view class="card-title">æ ¸å¿ƒæ•°æ®</view>
      <view class="main-stats">
        <view class="stat-item">
          <view class="stat-icon-wrapper">
            <view class="stat-icon">ğŸ“…</view>
          </view>
          <view class="stat-value">{{stats.totalDays}}</view>
          <view class="stat-label">æ‰“å¡å¤©æ•°</view>
        </view>
        <view class="stat-item" wx:if="{{stats.weightChange !== null}}">
          <view class="stat-icon-wrapper">
            <view class="stat-icon {{stats.weightChange < 0 ? 'stat-icon-down' : stats.weightChange > 0 ? 'stat-icon-up' : ''}}">
              {{stats.weightChange < 0 ? 'ğŸ“‰' : stats.weightChange > 0 ? 'ğŸ“ˆ' : 'âš–ï¸'}}
            </view>
          </view>
          <view class="stat-value {{stats.weightChange < 0 ? 'stat-value-down' : stats.weightChange > 0 ? 'stat-value-up' : ''}}">
            {{stats.weightChange > 0 ? '+' : ''}}{{stats.weightChange}}
          </view>
          <view class="stat-label">ä½“é‡å˜åŒ–ï¼ˆæ–¤ï¼‰</view>
        </view>
        <view class="stat-item" wx:if="{{stats.maxConsecutiveDays > 0}}">
          <view class="stat-icon-wrapper">
            <view class="stat-icon">ğŸ”¥</view>
          </view>
          <view class="stat-value">{{stats.maxConsecutiveDays}}</view>
          <view class="stat-label">æœ€é•¿è¿ç»­</view>
        </view>
      </view>
    </view>

    <!-- ä½“é‡æ•°æ®å¡ç‰‡ -->
    <view wx:if="{{stats.startWeight}}" class="stats-card weight-change-card">
      <view class="card-title">ä½“é‡å˜åŒ–</view>
      
      <!-- ä½“é‡å¯¹æ¯”åŒºåŸŸ -->
      <view class="weight-comparison-section">
        <view class="weight-item-box">
          <view class="weight-item-bg"></view>
          <view class="weight-item-content">
            <view class="weight-label">å¹´åˆä½“é‡</view>
            <view class="weight-value">{{stats.startWeight}}<text class="unit">æ–¤</text></view>
            <view class="weight-date">{{stats.startDate}}</view>
          </view>
        </view>
        <view class="weight-arrow-container">
          <view class="weight-arrow-line"></view>
          <view class="weight-arrow-icon">
            <van-icon name="arrow" size="28rpx" color="#188be4" />
          </view>
        </view>
        <view class="weight-item-box weight-item-end">
          <view class="weight-item-bg weight-item-bg-end"></view>
          <view class="weight-item-content">
            <view class="weight-label">å¹´æœ«ä½“é‡</view>
            <view class="weight-value {{stats.weightChange < 0 ? 'weight-down' : stats.weightChange > 0 ? 'weight-up' : ''}}">
              {{stats.endWeight}}<text class="unit">æ–¤</text>
            </view>
            <view class="weight-date">{{stats.endDate}}</view>
          </view>
        </view>
      </view>
      
      <!-- BMIå…³è”åŒºåŸŸ -->
      <view wx:if="{{stats.startBMI && stats.endBMI}}" class="bmi-section">
        <view class="bmi-divider"></view>
        <view class="bmi-comparison">
          <view class="bmi-item-box">
            <view class="bmi-label">å¹´åˆBMI</view>
            <view class="bmi-value-wrapper">
              <text class="bmi-value">{{stats.startBMI}}</text>
              <text class="bmi-category">ï¼ˆ{{stats.startBMICategory}}ï¼‰</text>
            </view>
          </view>
          <view class="bmi-arrow-container">
            <view class="bmi-arrow-line"></view>
            <view class="bmi-arrow-icon">â†’</view>
          </view>
          <view class="bmi-item-box bmi-item-end">
            <view class="bmi-label">å¹´æœ«BMI</view>
            <view class="bmi-value-wrapper">
              <text class="bmi-value {{stats.bmiChange < 0 ? 'bmi-down' : stats.bmiChange > 0 ? 'bmi-up' : ''}}">{{stats.endBMI}}</text>
              <text class="bmi-category {{stats.bmiChange < 0 ? 'bmi-down' : stats.bmiChange > 0 ? 'bmi-up' : ''}}">ï¼ˆ{{stats.endBMICategory}}ï¼‰</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- ä½“é‡æå€¼å¡ç‰‡ -->
    <view wx:if="{{stats.maxWeight}}" class="stats-card">
      <view class="card-title">ä½“é‡æå€¼</view>
      <view class="extreme-stats">
        <view class="extreme-item">
          <view class="extreme-label">æœ€é‡</view>
          <view class="extreme-value">{{stats.maxWeight}}<text class="unit">æ–¤</text></view>
          <view class="extreme-date">{{stats.maxWeightDate}}</view>
        </view>
        <view class="extreme-item">
          <view class="extreme-label">æœ€è½»</view>
          <view class="extreme-value">{{stats.minWeight}}<text class="unit">æ–¤</text></view>
          <view class="extreme-date">{{stats.minWeightDate}}</view>
        </view>
        <view class="extreme-item" wx:if="{{stats.avgWeight}}">
          <view class="extreme-label">å¹³å‡</view>
          <view class="extreme-value">{{stats.avgWeight}}<text class="unit">æ–¤</text></view>
        </view>
      </view>
      <!-- é«˜å…‰æœˆä»½è§£è¯» -->
      <view wx:if="{{stats.highlightMonth && stats.highlightMonthLoss}}" class="highlight-month">
        <view class="highlight-text">
          {{highlightMonthText}}æœˆ = ä½ çš„ã€Œé€†è¢­æœˆã€ï¼æœ¬æœˆç˜¦äº†{{highlightMonthLossText}}æ–¤ï¼Œè¿™æ‰§è¡ŒåŠ›å¤ªé¡¶äº†ï½
        </view>
      </view>
    </view>

    <!-- ä½“é‡è¶‹åŠ¿å›¾ -->
    <view wx:if="{{chartData.xData.length > 0}}" class="stats-card chart-card">
      <view class="card-title">ä½“é‡è¶‹åŠ¿</view>
      <view class="chart-container">
        <ec-canvas id="yearly-chart" canvas-id="yearly-chart" ec="{{ ec }}"></ec-canvas>
      </view>
    </view>

    <!-- æœˆåº¦ç»Ÿè®¡ -->
    <view wx:if="{{monthlyStatsArray.length > 0}}" class="stats-card">
      <view class="card-title">æœˆåº¦æ‰“å¡ç»Ÿè®¡</view>
      <view class="monthly-stats">
        <view class="month-item {{monthData.month === stats.highlightMonth ? 'highlight-month-item' : ''}} {{monthData.month === stats.maxCountMonth ? 'max-count-month-item' : ''}}" 
              wx:for="{{monthlyStatsArray}}" wx:key="month" wx:for-item="monthData">
          <view class="month-label">
            {{monthData.monthText}}æœˆ
            <text wx:if="{{monthData.month === stats.highlightMonth}}" class="month-badge highlight-badge">é€†è¢­æœˆ</text>
            <text wx:if="{{monthData.month === stats.maxCountMonth && monthData.count >= 28}}" class="month-badge count-badge">åŠ³æ¨¡æœˆ</text>
          </view>
          <view class="month-count">{{monthData.count}}æ¬¡</view>
          <view class="month-avg" wx:if="{{monthData.avgWeight}}">å‡é‡{{monthData.avgWeight}}æ–¤</view>
          <view class="month-loss" wx:if="{{monthData.weightLoss && monthData.weightLoss > 0}}">æœ¬æœˆç˜¦äº†{{monthData.weightLossText}}æ–¤</view>
        </view>
      </view>
    </view>

    <!-- é¼“åŠ±è¯è¯­ -->
    <view class="encouragement-card">
      <view class="encouragement-text">{{encouragementText}}</view>
    </view>
    
    <!-- è¡ŒåŠ¨å¼•å¯¼å’Œåˆ†äº«ï¼ˆä»…è‡ªå·±çš„æŠ¥å‘Šæ˜¾ç¤ºï¼‰ -->
    <view wx:if="{{!openId}}" class="action-buttons">
      <van-button type="primary" size="large" round bindtap="setTargetWeight" class="action-btn">
        è®¾ç½®2026å¹´ç†æƒ³ä½“é‡
      </van-button>
      
      <!-- åˆ†äº«æŒ‰é’® -->
      <view class="share-buttons">
        <van-button 
          type="info" 
          size="large" 
          round 
          bindtap="shareToTimeline" 
          class="share-btn">
          åˆ†äº«åˆ°æœ‹å‹åœˆ
        </van-button>
        <van-button 
          plain
          type="info" 
          size="large" 
          round 
          open-type="share"
          class="share-btn"
          bindtap="showShareTip">
          åˆ†äº«ç»™å¥½å‹
        </van-button>
      </view>
    </view>
    
    <!-- æŸ¥çœ‹ä»–äººæŠ¥å‘Šæ—¶çš„æç¤º -->
    <view wx:else class="view-others-tip" bindtap="goToIndex">
      <view class="tip-text">è¿™æ˜¯{{stats.userInfo.nickName}}çš„å¹´åº¦æŠ¥å‘Š</view>
      <view class="tip-subtext">æƒ³è¦ç”Ÿæˆè‡ªå·±çš„æŠ¥å‘Šï¼Ÿå¿«å»æ‰“å¡è®°å½•ä½“é‡å§ï¼</view>
    </view>
  </view>
  
  <!-- è®¾ç½®ç›®æ ‡ä½“é‡å¼¹çª— -->
  <van-dialog 
    use-slot 
    title="è®¾ç½®2026å¹´ç†æƒ³ä½“é‡" 
    show="{{ showTargetDialog }}" 
    bind:close="closeTargetDialog"
    show-cancel-button
    zIndex="100000">
    <view class="target-dialog-content">
      <van-field 
        type="digit" 
        label="ç†æƒ³ä½“é‡" 
        value="{{ targetWeight }}" 
        placeholder="è¯·è¾“å…¥ç†æƒ³ä½“é‡ï¼ˆæ–¤ï¼‰" 
        border="{{ true }}" 
        bind:change="onTargetWeightChange" />
      <view wx:if="{{ targetWeight && stats.endWeight }}" class="target-info">
        <view class="target-text">éœ€å†å‡ï¼š<text class="target-value">{{targetWeightLoss}}æ–¤</text></view>
        <view class="target-progress">
          <view class="progress-bar">
            <view class="progress-fill" style="width: {{targetProgress}}%"></view>
          </view>
        </view>
      </view>
    </view>
  </van-dialog>
  
  <!-- æµ·æŠ¥å›¾ç‰‡å¼¹çª— -->
  <van-dialog 
    cancelButtonText="å–æ¶ˆ" 
    confirmButtonText="{{confirmButtonText}}" 
    bind:close="downLoadPosterImage" 
    closeOnClickOverlay="{{true}}" 
    use-slot 
    show="{{ fileid && showPosterImage }}" 
    showCancelButton="{{true}}" 
    showConfirmButton="{{showImageButton}}" 
    zIndex="1000001">
    <image class="coverImage" src="{{fileid}}" bindtap="hidePosterImage" mode="widthFix"></image>
  </van-dialog>
  
  <!-- æµ·æŠ¥ç”Ÿæˆç»„ä»¶ -->
  <canvasdrawer painting="{{painting}}" class="canvasdrawer" bind:getImage="eventGetImage"/>
</view>

